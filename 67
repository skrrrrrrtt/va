repeat task.wait() until game:IsLoaded()

local function log(msg)
    print("[PLSD] >> " .. tostring(msg))
end

log("Starting script...")

-- USER SETTINGS
_G.goalAmount = 1000
_G.begInterval = 45
_G.begMessages = {
    "please donate if you can",
    "any small donation helps",
    "trying to reach my goal",
    "even 1 robux helps",
    "saving up for my booth",
    "grinding my goal",
    "any support means a lot"
}

_G.minPlayersBeforeHop = 5
_G.serverSearchPages = 8
_G.initialHopWait = 15
_G.boardUpdateInterval = 8

-- SERVICES
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local Workspace = workspace
local VirtualUser = game:GetService("VirtualUser")

-- ANTI-AFK
LocalPlayer.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

-- WAIT FOR UI
local pg = LocalPlayer:WaitForChild("PlayerGui")
repeat task.wait() until pg:FindFirstChild("MapUIContainer")
local BoothUI = pg.MapUIContainer.MapUI:WaitForChild("BoothUI")

local raisedStat = LocalPlayer:WaitForChild("leaderstats"):WaitForChild("Raised")

-- SAFE REQUIRE
local function requirex(module)
    local result
    repeat
        local ok, res = pcall(require, module)
        if ok then result = res end
        task.wait(0.05)
    until result
    return result
end

local RemotesModule = requirex(ReplicatedStorage.Remotes)

----------------------------------------------------------------------
-- SMART SERVER HOP
----------------------------------------------------------------------
local function searchServers(pages)
    local servers = {}
    local cursor = nil

    for i = 1, pages do
        local url = "https://games.roblox.com/v1/games/"..game.PlaceId.."/servers/Public?sortOrder=Asc&limit=100"
        if cursor then url = url .. "&cursor="..cursor end

        local ok, body = pcall(game.HttpGet, game, url)
        if not ok then break end

        local data = HttpService:JSONDecode(body)
        if not data then break end

        for _, srv in ipairs(data.data) do
            if srv.id ~= game.JobId and srv.playing < srv.maxPlayers then
                table.insert(servers, srv)
            end
        end

        if data.nextPageCursor then 
            cursor = data.nextPageCursor 
        else 
            break 
        end
    end
    return servers
end

local function hopIfLow()
    task.wait(_G.initialHopWait)
    while task.wait(12) do
        local count = #Players:GetPlayers()
        log("Players in server: "..count)

        if count <= _G.minPlayersBeforeHop then
            local servers = searchServers(_G.serverSearchPages)
            if #servers == 0 then
                return TeleportService:Teleport(game.PlaceId)
            end
            local pick = servers[math.random(1,#servers)]
            return TeleportService:TeleportToPlaceInstance(game.PlaceId, pick.id)
        end
    end
end

task.spawn(hopIfLow)

----------------------------------------------------------------------
-- CLAIM BOOTH
----------------------------------------------------------------------
local mainCheckPosition = Vector3.new(165,0,311)

local function findUnclaimed(radius)
    local list = {}
    for _, ui in ipairs(BoothUI:GetChildren()) do
        if ui:FindFirstChild("Details")
           and ui.Details.Owner.Text:lower():find("unclaim") then

            local slot = tonumber(ui.Name:match("%d+"))
            if slot then
                for _, booth in ipairs(Workspace.BoothInteractions:GetChildren()) do
                    if booth:GetAttribute("BoothSlot") == slot then
                        local dist = (booth.Position * Vector3.new(1,0,1) - mainCheckPosition).Magnitude
                        if dist < radius then
                            table.insert(list, slot)
                        end
                    end
                end
            end
        end
    end
    return list
end

local function claimFlow()
    log("Claiming booth...")
    local unclaimed = findUnclaimed(120)
    if #unclaimed == 0 then unclaimed = findUnclaimed(9999) end
    if #unclaimed == 0 then return end

    local slot = unclaimed[1]
    RemotesModule.Event("ClaimBooth"):InvokeServer(slot)
    task.wait(1)

    for _, booth in ipairs(Workspace.BoothInteractions:GetChildren()) do
        if booth:GetAttribute("BoothSlot") == slot then
            local hrp = LocalPlayer.Character:WaitForChild("HumanoidRootPart")
            hrp.CFrame = booth.CFrame * CFrame.new(3,3,3)

            -- FACE FRONT FIX
            hrp.CFrame = CFrame.new(hrp.Position, hrp.Position + Vector3.new(0,0,-1))
        end
    end
end

task.spawn(function()
    task.wait(2)
    claimFlow()
end)

LocalPlayer.CharacterAdded:Connect(function()
    task.wait(2)
    claimFlow()
end)

----------------------------------------------------------------------
-- CUSTOM THEMED BOOTH TEXT (FIXED WITH filter=false)
----------------------------------------------------------------------
local function updateBoothText()
    local raised = raisedStat.Value
    local goal = _G.goalAmount

    -- YOUR RAW THEME
    local themedText = string.format([[
<stroke color="#2A0030" thickness="5">
    <font size="25">
        <font color="#445094">
            <font face="Bangers">
                Horror Effects Designer!
            </font>
        </font>
    </font>
</stroke>

Anything Helps!
Status: AFK

<b>GOAL %s / %s</b>
]], raised, goal)

    RemotesModule.Event("SetCustomization"):FireServer({
        text = themedText,
        richText = true,
        filter = false, -- **THE FIX FOR ########**
        textFont = Enum.Font.FredokaOne,
        textColor = Color3.new(1,1,1),
        strokeColor = Color3.new(0,0,0),
        strokeOpacity = 0,
        buttonColor = Color3.fromRGB(98,255,0),
        buttonHoverColor = Color3.fromRGB(98,255,0)
    }, "booth")
end

----------------------------------------------------------------------
-- DONATION JUMP
----------------------------------------------------------------------
local last = raisedStat.Value
raisedStat.Changed:Connect(function(new)
    if new > last then
        local hum = LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
        if hum then
            for i = 1,3 do
                hum:ChangeState(Enum.HumanoidStateType.Jumping)
                task.wait(0.3)
            end
        end
        updateBoothText()
    end
    last = new
end)

----------------------------------------------------------------------
-- DANCE CYCLE
----------------------------------------------------------------------
task.spawn(function()
    while true do
        local hum = LocalPlayer.Character:FindFirstChild("Humanoid")
        if hum then
            pcall(function() hum:LoadAnimation(LocalPlayer.Character.Animate.dance.Animation1):Play() end)
        end
        task.wait(60)

        if hum then
            pcall(function() hum:LoadAnimation(LocalPlayer.Character.Animate.dance2.Animation2):Play() end)
        end
        task.wait(60)

        if hum then
            pcall(function() hum:LoadAnimation(LocalPlayer.Character.Animate.dance3.Animation3):Play() end)
        end
        task.wait(60)
    end
end)

----------------------------------------------------------------------
-- AUTO BEGGING (FIXED)
----------------------------------------------------------------------
local function sayChat(msg)
    local chat = ReplicatedStorage.DefaultChatSystemChatEvents.SayMessageRequest
    chat:FireServer(msg, "All")
end

task.spawn(function()
    while true do
        local msg = _G.begMessages[math.random(1,#_G.begMessages)]
        sayChat(msg)
        task.wait(_G.begInterval)
    end
end)

----------------------------------------------------------------------
-- BOARD TEXT UPDATE LOOP
----------------------------------------------------------------------
task.spawn(function()
    while true do
        updateBoothText()
        task.wait(_G.boardUpdateInterval)
    end
end)

log("FULLY FIXED SCRIPT LOADED SUCCESSFULLY.")
