repeat task.wait() until game:IsLoaded()

local function log(msg)
    print("[PLSD] >> " .. tostring(msg))
end

-- SETTINGS
_G.goalAmount = 1000
_G.textHex = "#32CD32"
_G.font = Enum.Font.FredokaOne
_G.minPlayersBeforeHop = 5
_G.initialHopWait = 15
_G.serverSearchPages = 8

_G.begInterval = 45
_G.begMessages = {
    "please donate if you can",
    "any small donation helps",
    "trying to reach my goal",
    "even 1 robux helps",
    "saving up for my booth",
    "grinding for my goal",
    "trying to upgrade my stand",
    "any support means a lot"
}

_G.boardUpdateInterval = 8

local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local VirtualUser = game:GetService("VirtualUser")
local Workspace = workspace

-- ANTI-AFK
LocalPlayer.Idled:Connect(function()
    log("Anti-AFK triggered.")
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

-- WAIT FOR UI
local pg = LocalPlayer:WaitForChild("PlayerGui")
repeat task.wait() until pg:FindFirstChild("MapUIContainer")
local BoothUI = pg.MapUIContainer.MapUI:WaitForChild("BoothUI")
local raisedStat = LocalPlayer:WaitForChild("leaderstats"):WaitForChild("Raised")

-- REQUIREX (SAFE REMOTE REQUIRE)
local function requirex(module)
    local loaded
    repeat
        local ok, res = pcall(require, module)
        if ok then loaded = res end
        if not loaded then task.wait(0.1) end
    until loaded
    return loaded
end

local RemotesModule = nil
if ReplicatedStorage:FindFirstChild("Remotes") then
    RemotesModule = requirex(ReplicatedStorage.Remotes)
end

-- HEX â†’ COLOR3
local function hexToColor3(hex)
    hex = hex:gsub("#","")
    return Color3.fromRGB(
        tonumber(hex:sub(1,2),16),
        tonumber(hex:sub(3,4),16),
        tonumber(hex:sub(5,6),16)
    )
end

local textColor = hexToColor3(_G.textHex)

-- SERVER SEARCH
local function searchServers(pages)
    local all = {}
    local cursor
    local baseUrl = "https://games.roblox.com/v1/games/"..game.PlaceId.."/servers/Public?sortOrder=Asc&limit=100"

    for i = 1, pages do
        local url = cursor and (baseUrl .. "&cursor="..cursor) or baseUrl
        local ok, body = pcall(game.HttpGet, game, url)
        if not ok then break end

        local data = HttpService:JSONDecode(body)
        if not data or not data.data then break end

        for _, srv in ipairs(data.data) do
            if srv.id ~= game.JobId and srv.playing < srv.maxPlayers then
                table.insert(all, {id=srv.id, players=srv.playing, max=srv.maxPlayers})
            end
        end

        if data.nextPageCursor and data.nextPageCursor ~= "null" then
            cursor = data.nextPageCursor
        else
            break
        end
    end

    return all
end

local function findBestServer(servers)
    local best = nil
    for _, srv in ipairs(servers) do
        if not best or (srv.players > best.players and srv.players < srv.max - 2) then
            best = srv
        end
    end
    return best
end

local function doSmartHop()
    log("Searching servers for hop candidate...")
    local servers = searchServers(_G.serverSearchPages)
    if #servers == 0 then
        log("No servers found. Teleport fallback.")
        return TeleportService:Teleport(game.PlaceId)
    end
    local best = findBestServer(servers)
    if best then
        log("Hopping to server: " .. best.id .. " players="..best.players)
        TeleportService:TeleportToPlaceInstance(game.PlaceId, best.id)
    else
        local randomServer = servers[math.random(1, #servers)]
        TeleportService:TeleportToPlaceInstance(game.PlaceId, randomServer.id)
    end
end

task.spawn(function()
    task.wait(_G.initialHopWait)
    while task.wait(20) do
        local count = #Players:GetPlayers()
        log("Server player count: " .. count)
        if count <= _G.minPlayersBeforeHop then
            log("Low player count. Hopping...")
            doSmartHop()
            return
        end
    end
end)

-- FIND UNCLAIMED BOOTH
local mainCheckPosition = Vector3.new(165.161, 0, 311.636)
local function findUnclaimedNearby(maxDistance)
    local list = {}
    for _, ui in ipairs(BoothUI:GetChildren()) do
        if ui:FindFirstChild("Details")
           and ui.Details.Owner.Text:lower():find("unclaim") then

            local slot = tonumber(ui.Name:match("%d+"))
            if slot then
                for _, part in ipairs(Workspace.BoothInteractions:GetChildren()) do
                    if part:GetAttribute("BoothSlot") == slot then
                        local dist = (part.Position * Vector3.new(1,0,1) - mainCheckPosition).Magnitude
                        if dist < maxDistance then
                            list[#list+1] = slot
                        end
                    end
                end
            end
        end
    end
    return list
end

-- CLAIM REMOTE + PROXIMITY
local function firePrompt(slot)
    for _, part in ipairs(Workspace.BoothInteractions:GetChildren()) do
        if part:GetAttribute("BoothSlot") == slot then
            local prompt = part:FindFirstChildOfClass("ProximityPrompt") or part:FindFirstChild("Claim")
            if prompt then
                pcall(fireproximityprompt, prompt, 0)
                return true
            end
        end
    end
    return false
end

local function tryClaimSlot(slot)
    if RemotesModule then
        local ok = pcall(function()
            RemotesModule.Event("ClaimBooth"):InvokeServer(slot)
        end)
        task.wait(1)
    end
    firePrompt(slot)
    return true
end

-- CLAIM FLOW
local function claimFlow()
    local unclaimed = findUnclaimedNearby(100)
    if #unclaimed == 0 then unclaimed = findUnclaimedNearby(9999) end
    if #unclaimed == 0 then return end

    local slot = unclaimed[1]
    tryClaimSlot(slot)

    for _, part in ipairs(Workspace.BoothInteractions:GetChildren()) do
        if part:GetAttribute("BoothSlot") == slot then
            local char = LocalPlayer.Character or LocalPlayer.CharacterAdded:Wait()
            local hrp = char:WaitForChild("HumanoidRootPart")
            hrp.CFrame = part.CFrame * CFrame.new(3,3,3)
            task.wait(0.2)
            hrp.CFrame = CFrame.new(hrp.Position)

            pcall(function()
                char.Humanoid:LoadAnimation(char.Animate.dance.Animation1):Play()
            end)
            break
        end
    end
end

task.spawn(function()
    task.wait(1.5)
    claimFlow()
end)

LocalPlayer.CharacterAdded:Connect(function()
    task.wait(2)
    claimFlow()
end)

-- UPDATE BOOTH TEXT
local function updateBoothText()
    local raised = raisedStat.Value or 0
    local text = "<b>GOAL " .. raised .. " / " .. _G.goalAmount .. "</b>"

    pcall(function()
        RemotesModule.Event("SetCustomization"):FireServer({
            text = text,
            richText = true,
            textFont = _G.font,
            textColor = textColor,
            strokeColor = Color3.new(0,0,0),
            strokeOpacity = 0,
            buttonStrokeColor = Color3.new(0,0,0),
            buttonTextColor = Color3.new(1,1,1),
            buttonColor = Color3.fromRGB(98,255,0),
            buttonHoverColor = Color3.fromRGB(98,255,0),
            buttonLayout = ""
        }, "booth")
    end)
end

-- DONATION JUMP
local last = raisedStat.Value
raisedStat.Changed:Connect(function(new)
    if new > last then
        local hum = LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
        if hum then
            for i = 1,3 do
                hum:ChangeState(Enum.HumanoidStateType.Jumping)
                task.wait(0.35)
            end
        end
        updateBoothText()
    end
    last = new
end)

-- DANCE ROTATION
task.spawn(function()
    while true do
        local char = LocalPlayer.Character
        if char and char:FindFirstChild("Animate") then
            pcall(function() char.Humanoid:LoadAnimation(char.Animate.dance.Animation1):Play() end)
        end
        task.wait(60)
        if char then
            pcall(function() char.Humanoid:LoadAnimation(char.Animate.dance2.Animation2):Play() end)
        end
        task.wait(60)
        if char then
            pcall(function() char.Humanoid:LoadAnimation(char.Animate.dance3.Animation3):Play() end)
        end
        task.wait(60)
    end
end)

-- AUTO BEGGING
local function sayChat(msg)
    pcall(function()
        ReplicatedStorage.DefaultChatSystemChatEvents.SayMessageRequest:FireServer(msg, "All")
    end)
end

task.spawn(function()
    while task.wait(_G.begInterval) do
        local msg = _G.begMessages[math.random(1,#_G.begMessages)]
        sayChat(msg)
    end
end)

-- BOARD UPDATE LOOP
task.spawn(function()
    while task.wait(_G.boardUpdateInterval) do
        updateBoothText()
    end
end)

log("FULL CLEAN SCRIPT LOADED WITHOUT ERRORS.")
