repeat task.wait() until game:IsLoaded()

local function log(msg)
    print("[PLSD] >> " .. tostring(msg))
end

-- SETTINGS
_G.goalAmount = 1000
_G.begInterval = 45
_G.begMessages = {
    "please donate if you can",
    "any small donation helps",
    "trying to reach my goal",
    "even 1 robux helps",
    "saving up for my booth",
    "grinding my goal",
    "any support means a lot"
}

_G.minPlayersBeforeHop = 5
_G.serverSearchPages = 8
_G.initialHopWait = 15
_G.boardUpdateInterval = 8

-- SERVICES
local Players = game:GetService("Players")
local LocalPlayer = Players.LocalPlayer
local ReplicatedStorage = game:GetService("ReplicatedStorage")
local TeleportService = game:GetService("TeleportService")
local HttpService = game:GetService("HttpService")
local Workspace = workspace
local VirtualUser = game:GetService("VirtualUser")
local TextChatService = pcall(function() return game:GetService("TextChatService") end) and game:GetService("TextChatService") or nil

-- ANTI AFK
LocalPlayer.Idled:Connect(function()
    VirtualUser:CaptureController()
    VirtualUser:ClickButton2(Vector2.new())
end)

-- WAIT UI
local pg = LocalPlayer:WaitForChild("PlayerGui")
repeat task.wait() until pg:FindFirstChild("MapUIContainer")
local BoothUI = pg.MapUIContainer.MapUI:WaitForChild("BoothUI")
repeat task.wait() until LocalPlayer.Character and LocalPlayer.Character:FindFirstChild("HumanoidRootPart")
local raisedStat = LocalPlayer:WaitForChild("leaderstats"):WaitForChild("Raised")

-- SAFE REQUIRE
local function requirex(module)
    local result
    repeat
        local ok, res = pcall(require, module)
        if ok then result = res end
        task.wait(0.05)
    until result
    return result
end

local RemotesModule = requirex(ReplicatedStorage:WaitForChild("Remotes"))

----------------------------------------------------------------------
-- SMART SERVER HOP
----------------------------------------------------------------------
local function searchServers(pages)
    local servers = {}
    local cursor = nil

    for i = 1, pages do
        local url = "https://games.roblox.com/v1/games/"..game.PlaceId.."/servers/Public?sortOrder=Asc&limit=100"
        if cursor then url = url .. "&cursor=" .. cursor end

        local ok, body = pcall(game.HttpGet, game, url)
        if not ok then break end

        local data = HttpService:JSONDecode(body)
        if not data then break end

        for _, srv in ipairs(data.data) do
            if srv.id ~= game.JobId and srv.playing < srv.maxPlayers then
                table.insert(servers, srv)
            end
        end

        if data.nextPageCursor then cursor = data.nextPageCursor else break end
    end

    return servers
end

local function doSmartHop()
    local servers = searchServers(_G.serverSearchPages)
    if #servers == 0 then
        TeleportService:Teleport(game.PlaceId)
        return
    end

    local pick = servers[math.random(1,#servers)]
    TeleportService:TeleportToPlaceInstance(game.PlaceId, pick.id)
end

task.spawn(function()
    task.wait(_G.initialHopWait)
    while true do
        local count = #Players:GetPlayers()
        if count <= _G.minPlayersBeforeHop then
            doSmartHop()
            break
        end
        task.wait(20)
    end
end)

----------------------------------------------------------------------
-- BOOTH CLAIM
----------------------------------------------------------------------
local mainCheckPosition = Vector3.new(165,0,311)

local function isRealBooth(part)
    if not part then return false end
    if type(part.GetAttribute) ~= "function" then return false end
    local slot = part:GetAttribute("BoothSlot")
    return typeof(slot) == "number"
end

local function findUnclaimedNearby(radius)
    local list = {}
    for _, ui in ipairs(BoothUI:GetChildren()) do
        if ui:FindFirstChild("Details") and ui.Details.Owner.Text:lower():find("unclaim") then
            local slot = tonumber(ui.Name:match("%d+"))
            if slot then
                for _, booth in ipairs(Workspace.BoothInteractions:GetChildren()) do
                    if isRealBooth(booth) and booth:GetAttribute("BoothSlot") == slot then
                        local pos = booth.Position or booth.CFrame.Position
                        local dist = (pos * Vector3.new(1,0,1) - mainCheckPosition).Magnitude
                        if dist < radius then
                            table.insert(list, slot)
                        end
                    end
                end
            end
        end
    end
    return list
end

local function tryClaimSlot(slot)
    pcall(function()
        RemotesModule.Event("ClaimBooth"):InvokeServer(slot)
    end)

    task.wait(0.8)

    for _, booth in ipairs(Workspace.BoothInteractions:GetChildren()) do
        if isRealBooth(booth) and booth:GetAttribute("BoothSlot") == slot then
            local prompt = booth:FindFirstChildOfClass("ProximityPrompt")
            if prompt then pcall(fireproximityprompt, prompt, 0) end
        end
    end
end

local function claimFlow()
    local slots = findUnclaimedNearby(100)
    if #slots == 0 then slots = findUnclaimedNearby(9999) end
    if #slots == 0 then return end

    local slot = slots[1]
    tryClaimSlot(slot)

    task.wait(0.7)

    for _, booth in ipairs(Workspace.BoothInteractions:GetChildren()) do
        if isRealBooth(booth) and booth:GetAttribute("BoothSlot") == slot then
            local hrp = LocalPlayer.Character:WaitForChild("HumanoidRootPart")
            hrp.CFrame = booth.CFrame * CFrame.new(3,3,3)
            hrp.CFrame = CFrame.new(hrp.Position, hrp.Position + Vector3.new(0,0,-1)) -- FACE FORWARD
            return
        end
    end
end

task.spawn(function()
    task.wait(2)
    claimFlow()
end)

LocalPlayer.CharacterAdded:Connect(function()
    task.wait(2)
    claimFlow()
end)

----------------------------------------------------------------------
-- THEMED BOOTH TEXT (FIXED, NO FILTER)
----------------------------------------------------------------------
local function updateBoothText()
    local raised = raisedStat.Value
    local goal = _G.goalAmount

    -- PATCHED FONT: LuckiestGuy (SAFE)
    local themedText = string.format([[
<stroke color="#2A0030" thickness="5">
    <font size="25">
        <font color="#445094">
            <font face="LuckiestGuy">
                Horror Effects Designer!
            </font>
        </font>
    </font>
</stroke>

Anything Helps!
Status: AFK

<b>GOAL %s / %s</b>
]], tostring(raised), tostring(goal))

    RemotesModule.Event("SetCustomization"):FireServer({
        text = themedText,
        richText = true,
        filter = false, -- REQUIRED TO PREVENT ########
        textFont = Enum.Font.FredokaOne,
        buttonColor = Color3.fromRGB(98,255,0),
        buttonHoverColor = Color3.fromRGB(98,255,0)
    }, "booth")
end

task.spawn(function()
    while task.wait(_G.boardUpdateInterval) do
        updateBoothText()
    end
end)

----------------------------------------------------------------------
-- DONATION JUMP
----------------------------------------------------------------------
local lastRaise = raisedStat.Value
raisedStat.Changed:Connect(function(new)
    if new > lastRaise then
        local hum = LocalPlayer.Character:FindFirstChildOfClass("Humanoid")
        if hum then
            for i = 1,3 do
                hum:ChangeState(Enum.HumanoidStateType.Jumping)
                task.wait(0.3)
            end
        end
        updateBoothText()
    end

    lastRaise = new
end)

----------------------------------------------------------------------
-- DANCE 1 → 2 → 3 CYCLE
----------------------------------------------------------------------
task.spawn(function()
    while true do
        local char = LocalPlayer.Character
        local hum = char:FindFirstChildOfClass("Humanoid")

        if hum then pcall(function() hum:LoadAnimation(char.Animate.dance.Animation1):Play() end) end
        task.wait(60)
        if hum then pcall(function() hum:LoadAnimation(char.Animate.dance2.Animation2):Play() end) end
        task.wait(60)
        if hum then pcall(function() hum:LoadAnimation(char.Animate.dance3.Animation3):Play() end) end
        task.wait(60)
    end
end)

----------------------------------------------------------------------
-- ROBUST CHAT FUNCTION (FIXED)
----------------------------------------------------------------------
local function sayChat(msg)
    -- DefaultChatSystem
    local ok1 = pcall(function()
        local ev = ReplicatedStorage:WaitForChild("DefaultChatSystemChatEvents")
            :WaitForChild("SayMessageRequest")
        ev:FireServer(msg, "All")
    end)

    if ok1 then return true end

    -- TextChatService fallback
    if TextChatService and TextChatService.TextChannels and TextChatService.TextChannels:FindFirstChild("RBXGeneral") then
        local ok2 = pcall(function()
            TextChatService.TextChannels.RBXGeneral:SendAsync(msg)
        end)
        if ok2 then return true end
    end

    return false
end

----------------------------------------------------------------------
-- AUTO BEGGING (NO SILENCE, FIXED)
----------------------------------------------------------------------
task.spawn(function()
    while true do
        local msg = _G.begMessages[math.random(1,#_G.begMessages)]
        sayChat(msg)
        task.wait(_G.begInterval)
    end
end)
